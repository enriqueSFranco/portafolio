---
import cv from "../cv.json";
import ProjectCard from "./ProjectCard.astro";
import StackFilters from "./StackFilters.astro";

const { projects } = cv;
const techs = Array.from(new Set(projects.flatMap((p) => p.stack)));
---

<div class="w-full flex flex-col gap-6 reveal" data-delay="200">
  <StackFilters options={["Todos", ...techs]} active="Todos" />

  <ol
    id="projects-grid"
    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4 md:gap-5 lg:gap-6 auto-rows-fr"
  >
    {
      projects.map((project) => (
        <li
          data-tech={project.stack.join(" ").toLowerCase()}
          class="translate-y-4 transition-all duration-700 ease-[cubic-bezier(0.18,0.75,0.32,1)] will-change-transform"
        >
          <ProjectCard project={project} />
        </li>
      ))
    }
  </ol>
</div>

<script>
  const $buttons = document.querySelectorAll("[data-filter]");
  const $cards = document.querySelectorAll("#projects-grid li");

  // botón "Todos" (defensivo)
  const defaultBtn = document.querySelector('[data-filter="Todos"]') || document.querySelector('[data-filter="todos"]');

  if (defaultBtn) {
    defaultBtn.classList.add("active");
  }

  /**
   * filterHandler: maneja el click en un botón de filtro.
   */
  function filterHandler(btn) {
    const raw = btn.dataset.filter ?? "";
    const filter = String(raw).toLowerCase();

    // Reset estado botones
    $buttons.forEach((b) => b.classList.remove("active"));
    btn.classList.add("active");

    // Filtrar tarjetas
    $cards.forEach((card) => {
      const techs = (card.dataset.tech || "").toLowerCase();
      const isAll = filter === "todos" || filter === "";
      const matches = isAll || techs.includes(filter);

      card.classList.toggle("opacity-0", !matches);
      card.classList.toggle("scale-95", !matches);
      card.classList.toggle("pointer-events-none", !matches);

      // reactivar animación de entrada
      if (matches) {
        card.classList.remove("is-visible");
        setTimeout(() => card.classList.add("is-visible"), 20);
      }
    });
  }

  $buttons.forEach((btn) => {
    btn.addEventListener("click", (e) => {
      // en caso de que el click venga de un elemento hijo, nos aseguramos de usar el botón
      const clickedBtn = e.currentTarget;
      filterHandler(clickedBtn);
    });
  });

  // Ejecuta el filtrado inicial para que sólo se muestren las tarjetas correspondientes
  if (defaultBtn) {
    filterHandler(defaultBtn);
  }
</script>

